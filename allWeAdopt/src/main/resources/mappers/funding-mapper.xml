<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="fundingMapper">

	<!-- 게시글 상세조회용 resultMap -->
	<resultMap type="fundingDetail" id="detail_rm">

		<id property="fundingNo" column="FUNDING_NO" />
		<result property="fundingTitle" column="FUNDING_TITLE" />
		<result property="fundingMiniTitle" column="FUNDING_MINI_TITLE" />
		<result property="fundingContent" column="FUNDING_CONTENT" />
		<result property="targetDonation" column="TARGET_DONATION" />
		<result property="fundingSeason" column="FUNDING_SEASON" />
		<result property="SuccessDonation" column="SUCCESS_DONATION" />
		<result property="fundingState" column="FUNDING_ST" />
		<result property="fundingThumbnail" column="FUNDING_THUMBNAIL" />
		<result property="deliveryFee" column="DELIVERY_FEE" />

		<result property="CategoryName" column="CATEGORY_NM" />

		<result property="month" column="MONTH" />
		<result property="startDate" column="STARTDATE" />
		<result property="endDate" column="ENDDATE" />
		<result property="leftDate" column="LEFTDATE" />
	</resultMap>

	<!-- 게시글 목록 조회용 Result Map -->
	<resultMap type="funding" id="funding_rm">

		<id property="fundingNo" column="FUNDING_NO" />
		<result property="fundingTitle" column="FUNDING_TITLE" />
		<result property="paymentNo" column="PAYMENT_NO" />

		<result property="fundingMiniTitle" column="FUNDING_MINI_TITLE" />

		<result property="targetDonation" column="TARGET_DONATION" />
		<result property="fundingSeason" column="FUNDING_SEASON" />
		<result property="SuccessDonation" column="SUCCESS_DONATION" />
		<result property="fundingState" column="FUNDING_ST" />
		<result property="fundingThumbnail" column="FUNDING_THUMBNAIL" />
		<result property="deliveryFee" column="DELIVERY_FEE" />

		<result property="fundingCategory" column="CATEGORY_NM" />
		<result property="payDate" column="PAY_DT" />
		<result property="orderState" column="ORDER_ST" />
	</resultMap>


	<!-- 결제정보 상세 조회를 위한 ResultMap +  -->
	<resultMap type="orderDetail" id="orderDetail_re">
	
		<id property="fundingNo" column="FUNDING_NO" />
		<result property="fundingCategory" column="CATEGORY_NM" />
		<result property="fundingTitle" column="FUNDING_TITLE" />
		<result property="payDate" column="PAY_DT" />
		<result property="payMethod" column="PAY_METHOD" />
		<result property="fullPrice" column="FULL_PRICE" />
		<result property="orderState" column="ORDER_ST" />
		<result property="recipient" column="RECIPIENT" />
		<result property="orderPhoneMain" column="ORDER_PHONE1" />
		<result property="orderPhoneSub" column="ORDER_PHONE2" />
		<result property="orderAddress" column="ORDER_ADD" />
		<result property="paymentNo" column="PAYMENT_NO" />

		<collection property="rewardList" column="PAYMENT_NO" 
		javaType="java.util.ArrayList" ofType="reward"	
		select="selectRewards" />
			
	</resultMap>

	<!-- selectImageList의 조회 결과를 BoardDetail VO의 ImageList 필드에 담겟다 -> imageList에 
		담기 위한 ArrayList<BoardImage> 객체를 생성 ( javaType="java.util.ArrayList" ofType="boardImage" 
		) -> selectImageList 태그 수행 시 필요한 파라미터는 현재 resultMap (detail_rm)의 BOARD_NO 
		컬럼에 저장된 값을 매개변수로 전달하겟다라는 의미 한줄 요약 : 게시글 상세 조회 후 detail_rm , resultMap이 호출되었을 
		때 상세조회 결과중 BOARD_NO(게시글번호)를 이용해 SelectImageList를 수행하고 결과를 ImageList 필드에 세팅한다 -->

	
	<!-- 리워드 정보들을 조회하기 위한 resultMap -->
	<resultMap type="reward" id="reward_re">
		<id property="rewardNo" column="REWARD_NO" />
		<result property="rewardTitle" column="REWARD_TITLE" />
		<result property="rewardContent" column="REWARD_CONTENT" />
		<result property="fullPrice" column="FULL_PRICE" />
		<result property="rewardPrice" column="REWARD_PRICE" />
		<result property="maxRewardNo" column="MAX_REWARD_NO" />
		<result property="fundingNo" column="FUNDING_NO" />
		<result property="amount" column="AMOUNT" />
	</resultMap>



<!-- ==================================================================================== -->
	<!-- 펀딩 상세 내용 조회용 SQL -->
	<select id="selectFundingDetail" resultMap="detail_rm">
		SELECT FUNDING_NO,
		FUNDING_TITLE,
		FUNDING_MINI_TITLE,
		FUNDING_CONTENT,
		TO_CHAR(TARGET_DONATION,'999,999,999') AS TARGET_DONATION,
		FUNDING_SEASON,
		SUBSTR(FUNDING_SEASON,-2) AS MONTH,
		TO_CHAR(TO_DATE(REPLACE(FUNDING_SEASON,'/',''),'YYYYMM'),'YYYY"년"MM"월"DD"일"')
		AS STARTDATE,
		TO_CHAR(LAST_DAY(TO_DATE(REPLACE(FUNDING_SEASON,'/',''),'YYYYMM')),'YYYY"년"MM"월"DD"일"')
		AS ENDDATE,
		TRUNC(LAST_DAY(TO_DATE(REPLACE(FUNDING_SEASON,'/',''),'YYYYMM'))-SYSDATE)
		AS LEFTDATE,
		SUCCESS_DONATION,
		FUNDING_ST,
		FUNDING_THUMBNAIL,
		DELIVERY_FEE,
		CATEGORY_NM

		FROM FUNDING
		JOIN CATEGORY
		USING(FUNDING_CATEGORY)
		WHERE FUNDING_NO =
		#{fundingNo}
	</select>


	<!-- 해당 회원의 참여한 펀딩 개수를 조회하는 SQL -->
	<select id="getFundingCount" resultType="_int">
		SELECT DISTINCT count(*)
		FROM PAYMENT
		JOIN FUNDING USING(FUNDING_NO)
		WHERE MEMBER_NO=${memberNo}
	</select>


	<!-- [MY] 회원이 참여한 펀딩목록을 조회하는 SQL -->
	<select id="selectMyFundingList" resultMap="funding_rm">
		SELECT DISTINCT
		FUNDING_NO
		,PAYMENT_NO
		,FUNDING_TITLE
		,CATEGORY_NM
		,ORDER_ST
		,TO_CHAR(PAY_DT, 'YYYY-MM-DD')AS PAY_DT
		FROM PAYMENT
		JOIN FUNDING
		USING(FUNDING_NO)
		JOIN CATEGORY USING(FUNDING_CATEGORY)
		JOIN ORDER_ST
		USING(ORDER_ST_CD)
		WHERE MEMBER_NO=#{memberNo}
	</select>

	<!-- 현재 진행중인 펀딩 번호(interceptor) -->
	<select id="selectNowFundingNo" resultType="_int">
		SELECT FUNDING_NO
		FROM FUNDING
		WHERE FUNDING_ST='Y'
	</select>


	<!-- 결제번호를 가지고 하는 결제 정보 상세조회 -->
	<select id="selectOrderDetail" resultMap="orderDetail_re">
		SELECT
			FUNDING_NO
			,CATEGORY_NM
			,FUNDING_TITLE
			,TO_CHAR(PAY_DT,'YYYY.MM.DD') AS PAY_DT
			,PAY_METHOD
			,( SELECT SUM((REWARD_PRICE*AMOUNT))AS FULL_PRICE
			FROM
			REWARD_ORDER
			JOIN REWARD USING(REWARD_NO)
			JOIN PAYMENT USING(PAYMENT_NO)
			WHERE PAYMENT_NO=#{paymentNo}
			) AS FULL_PRICE
			,ORDER_ST
			,RECIPIENT
			,ORDER_PHONE1
			,ORDER_PHONE2
			,ORDER_ADD
    		,PAYMENT_NO
		FROM PAYMENT
		JOIN FUNDING
		USING(FUNDING_NO)
		JOIN ORDER_ST USING(ORDER_ST_CD)
		JOIN CATEGORY
		USING(FUNDING_CATEGORY)
		WHERE PAYMENT_NO=#{paymentNo}
	</select>

	<!-- 결제번호를 가지고 구매한 리워드를 조회하는 SQL -->
	<select id="selectRewards" resultMap="reward_re">
		SELECT
			REWARD_TITLE,
			AMOUNT,(REWARD_PRICE*AMOUNT)AS FULL_PRICE,
			REWARD_PRICE
		FROM REWARD_ORDER
		JOIN REWARD USING(REWARD_NO)
		JOIN PAYMENT
		USING(PAYMENT_NO)
		WHERE PAYMENT_NO=#{paymentNo}
	</select>

</mapper>